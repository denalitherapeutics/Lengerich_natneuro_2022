---
title: "Study1/Study2 comparison"
author: "David Tatarakis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_collapsed: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
Packages <-
  c(
    "atvtrem2Combined",
    "dplyr",
    "Seurat",
    "aws.s3",
    "Matrix",
    "ggplot2",
    "pheatmap",
    "RColorBrewer",
    "SingleCellExperiment",
    "scuttle"
  )
lapply(Packages, library, character.only = TRUE)

`%notin%` <- Negate(`%in%`)

set.seed(1234)
bucket1 <-
  "com.dnli.bioinfo.data/processed/internal/Study2/remapped"
bucket2 <- "com.dnli.bioinfo.data/processed/internal/NGS000073"

diss_stress <-
  read.csv(
    "~/DNLI-21-236_ATV-Trem2_APPKI_timecourse/inst/extdata/diss_stress.csv",
    sep = ",",
    header = T
  )
```

```{r, include=FALSE}
microglia_Study1 <- aws.s3::s3readRDS(
  bucket = bucket2,
  object = "Study1_microglia_subset.Rds",
  region = "us-west-2"
)

microglia_Study2 <- aws.s3::s3readRDS(
  bucket = bucket1,
  object = "ATV-Trem2_APPKI_microglia_analyzed.Rds",
  region = "us-west-2"
)
```


So let's take a look at both datasets.

In study #1, we have now `r dim(microglia_Study1)[2]` microglia.

In study #2, we have `r dim(microglia_Study2)[2]` microglia.


```{r, echo=FALSE, fig.width=10, fig.height=4}
DimPlot(microglia_Study1, label = T) + 
  DimPlot(microglia_Study2, 
          group.by = "seurat_clusters", 
          label = T)
```

And here they are split by treatment:
```{r, fig.width=6, fig.height=3}
DimPlot(microglia_Study1, 
        split.by = "group", 
        ncol = 3
) + NoAxes()
```

```{r, fig.width=5, fig.height=3}
DimPlot(
  microglia_Study2,
  split.by = "group",
  group.by = "seurat_clusters",
  ncol = 3
) + NoAxes()

```


The effects are clearly similar with ATV:4D9 treatment. 
There is a broad activation unique to this treatment. 

But let's see if we can dig deeper into the particular 
activation states being triggered in each case. 



# Differential state analysis

## Activation signatures
```{r, include=FALSE}
microglia_Study1$sample <- microglia_Study1$sample_id

# combine the objects so I can calculate relative sores
combined_object <- merge(microglia_Study1, microglia_Study2)

combined_object <- combined_object %>%
  NormalizeData(.)

signatures <- read.csv(
  "~/DNLI-21-236_ATV-Trem2_APPKI_timecourse/inst/extdata/state_signatures.csv", 
  sep = ",", 
  header = T)

chen_sigs <- signatures %>% filter(collection == "ChenColonna2021")
chen_sigs <- split(chen_sigs$symbol, chen_sigs$name)
names(chen_sigs) <- gsub("-", ".", names(chen_sigs))

topics <- signatures %>% filter(collection == "topics")
topics <- split(topics$symbol, topics$name)
```

### Chen Colonna Review signatures

These are the signatures from the Chen & Colonna 2021 review.

```{r, include=FALSE}
for (i in 1:length(chen_sigs)) {
  combined_object <- AddModuleScore(combined_object,
    features = list(chen_sigs[[i]]),
    name = paste0("C.C_", names(chen_sigs)[i], "_Score")
  )
}

for (i in 1:length(chen_sigs)) {
  microglia_Study1 <- AddModuleScore(microglia_Study1,
    features = list(chen_sigs[[i]]),
    name = paste0("C.C_", names(chen_sigs)[i], "_Score")
  )
}

for (i in 1:length(chen_sigs)) {
  microglia_Study2 <- AddModuleScore(microglia_Study2,
    features = list(chen_sigs[[i]]),
    name = paste0("C.C_", names(chen_sigs)[i], "_Score")
  )
}

chen_score_names <- paste0("C.C_", names(chen_sigs), "_Score1")
```

```{r, echo=FALSE, fig.width=12, fig.height=6, message=FALSE}
FeaturePlot(
  microglia_Study1,
  features = chen_score_names,
  min.cutoff = 0,
  order = T,
  ncol = 3
) &
  scale_color_gradientn(colors = brewer.pal("Oranges", n = 9)) &
  NoAxes()
```

```{r, echo=FALSE, fig.width=12, fig.height=6, message=FALSE}
FeaturePlot(
  microglia_Study2,
  features = chen_score_names,
  min.cutoff = 0,
  order = T,
  ncol = 3
) &
  scale_color_gradientn(colors = brewer.pal("Oranges", n = 9)) &
  NoAxes()
```


```{r,include=FALSE}
meta_slim <- combined_object@meta.data %>%
  dplyr::select(c(sample, group)) %>%
  distinct()

scores <-
  combined_object@meta.data %>% 
  dplyr::select(c(sample, all_of(chen_score_names)))

score_means <- scores %>%
  group_by(sample) %>%
  summarize_if(.predicate = is.numeric, .funs = mean) %>%
  tidyr::pivot_longer(values_to = "score", cols = all_of(chen_score_names)) %>%
  left_join(meta_slim, by = "sample") %>%
  dplyr::filter(
    group %in% c(
      "ATV:RSV",
      "WT_ATV-DNP02",
      "days_01",
      "WT_ATV-4D9",
      "APP-SAA_ATV-DNP02",
      "APP-SAA_ATV-4D9"
    )
  )

score_means$group <- factor(
  score_means$group,
  levels = c(
    "ATV:RSV",
    "WT_ATV-DNP02",
    "days_01",
    "WT_ATV-4D9",
    "APP-SAA_ATV-DNP02",
    "APP-SAA_ATV-4D9"
  )
)

score_means$group <- plyr::mapvalues(
  score_means$group,
  from = c(
    "ATV:RSV",
    "WT_ATV-DNP02",
    "days_01",
    "WT_ATV-4D9",
    "APP-SAA_ATV-DNP02",
    "APP-SAA_ATV-4D9"
  ),
  to = c(
    "Study1_WT-ATV:RSV",
    "Study2_WT-ATV:DNP02",
    "Study1_WT-ATV:4D9",
    "Study2_WT-ATV:4D9",
    "APP/SAA-ATV:DNP02",
    "APP/SAA-ATV:4D9"
  )
)
```

```{r, echo=FALSE, fig.width=10, fig.height=5}
ggplot(score_means, aes(x = group, y = score, color = group)) +
  geom_boxplot() +
  facet_wrap(~name, scales = "free_y") +
  geom_point() +
  theme_bw() +
  scale_color_manual(values = brewer.pal(name = "Dark2", n = 6)) +
  theme(axis.text.x = element_blank())
```

### Microglia Map signatures

These are the signatures I created using topic modeling on the Microglia Map.

```{r, include=FALSE}
for (i in 2:length(topics)) {
  combined_object <- AddModuleScore(combined_object,
    features = list(topics[[i]]),
    name = paste0("Topics_", names(topics)[i])
  )
}

for (i in 2:length(topics)) {
  microglia_Study1 <- AddModuleScore(microglia_Study1,
    features = list(topics[[i]]),
    name = paste0("Topics_", names(topics)[i])
  )
}

for (i in 2:length(topics)) {
  microglia_Study2 <- AddModuleScore(microglia_Study2,
    features = list(topics[[i]]),
    name = paste0("Topics_", names(topics)[i])
  )
}

topics_score_names <- paste0("Topics_", names(topics)[2:10], "1")
```

```{r, echo=FALSE, fig.width=12, fig.height=9, message=FALSE}
FeaturePlot(
  microglia_Study1,
  features = topics_score_names,
  min.cutoff = 0,
  order = T,
  ncol = 3
) &
  scale_color_gradientn(colors = brewer.pal("Oranges", n = 9)) &
  NoAxes()
```

```{r, echo=FALSE, fig.width=12, fig.height=9, message=FALSE}
FeaturePlot(
  microglia_Study2,
  features = topics_score_names,
  min.cutoff = 0,
  order = T,
  ncol = 3
) &
  scale_color_gradientn(colors = brewer.pal("Oranges", n = 9)) &
  NoAxes()
```

```{r,include=FALSE}
meta_slim <- combined_object@meta.data %>%
  dplyr::select(c(sample, group)) %>%
  distinct()

scores <-
  combined_object@meta.data %>% 
  dplyr::select(c(sample, all_of(topics_score_names)))

score_means <- scores %>%
  group_by(sample) %>%
  summarize_if(.predicate = is.numeric, .funs = mean) %>%
  tidyr::pivot_longer(values_to = "score", cols = all_of(topics_score_names)) %>%
  left_join(meta_slim, by = "sample") %>%
  dplyr::filter(
    group %in% c(
      "ATV:RSV",
      "WT_ATV-DNP02",
      "days_01",
      "WT_ATV-4D9",
      "APP-SAA_ATV-DNP02",
      "APP-SAA_ATV-4D9"
    )
  )

score_means$group <- factor(
  score_means$group,
  levels = c(
    "ATV:RSV",
    "WT_ATV-DNP02",
    "days_01",
    "WT_ATV-4D9",
    "APP-SAA_ATV-DNP02",
    "APP-SAA_ATV-4D9"
  )
)

score_means$group <- plyr::mapvalues(
  score_means$group,
  from = c(
    "ATV:RSV",
    "WT_ATV-DNP02",
    "days_01",
    "WT_ATV-4D9",
    "APP-SAA_ATV-DNP02",
    "APP-SAA_ATV-4D9"
  ),
  to = c(
    "Study1_WT-ATV:RSV",
    "Study2_WT-ATV:DNP02",
    "Study1_WT-ATV:4D9",
    "Study2_WT-ATV:4D9",
    "APP/SAA-ATV:DNP02",
    "APP/SAA-ATV:4D9"
  )
)
```

```{r, echo=FALSE, fig.width=10, fig.height=7}
ggplot(score_means, aes(x = group, y = score, color = group)) +
  geom_boxplot() +
  facet_wrap(~name, scales = "free_y") +
  geom_point() +
  theme_bw() +
  scale_color_manual(values = brewer.pal(name = "Dark2", n = 6)) +
  theme(axis.text.x = element_blank())
```

### Individual score genes
```{r, include=FALSE}
score_genes <-
  unique(c(as.vector(unlist(chen_sigs)), as.vector(unlist(topics))))

chen_annotation <-
  signatures %>% dplyr::filter(collection == "ChenColonna2021")
rownames(chen_annotation) <- chen_annotation$symbol
chen_annotation <- dplyr::select(chen_annotation, name)

chen_annotation_colors <- list(
  name = c(
    `Homeostatic` = "lightblue3",
    `DAM-like` = "coral2",
    `IFN` = "darkgreen",
    `MHC` = "grey20",
    `Cyc-M` = "lemonchiffon3"
  ),
  group = c(
    `Study1_WT-ATV-RSV` = "#1B9E77",
    `Study2_WT-ATV-DNP02` = "#D95F02",
    `Study1_WT-ATV-4D9` = "#7570B3",
    `Study2_WT-ATV-4D9` = "#E7298A",
    `APP/SAA-ATV-DNP02` = "#66A61E",
    `APP/SAA-ATV-4D9` = "#E6AB02"
  )
)

# we're only going to take 7 genes from each topic.
# Leaving out the homeostatic, LMP, and Cytokines topics.
topics_annotation <-
  signatures %>% dplyr::filter(
    collection == "topics" &
    name %notin% c("Cytokines", "LMP", "Homeostasis"))

topics_annotation <- topics_annotation %>%
  group_by(name) %>%
  slice_sample(n = 7) %>%
  as.data.frame()
rownames(topics_annotation) <- topics_annotation$symbol
topics_annotation <- dplyr::select(topics_annotation, name)

topics_annotation_colors <- list(
  name = c(
    `Lipid_metabolism` = "goldenrod",
    `IFN_response` = "darkgreen",
    `MHCII` = "grey20",
    `DAM_canonical1` = "coral1",
    `DAM_inflammatory_chemokines` = "red1",
    `DAM_inflammatory_cytokines` = "red4",
    `DAM_canonical2` = "coral3"
  ),
  group = c(
    `Study1_WT-ATV-RSV` = "#1B9E77",
    `Study2_WT-ATV-DNP02` = "#D95F02",
    `Study1_WT-ATV-4D9` = "#7570B3",
    `Study2_WT-ATV-4D9` = "#E7298A",
    `APP/SAA-ATV-DNP02` = "#66A61E",
    `APP/SAA-ATV-4D9` = "#E6AB02"
  )
)
```

```{r,include=FALSE}
# setting up a combined object that includes only the groups of interest. 
# Then factor and rename groups.
filtered_object <- subset(combined_object,
  subset = group %in% c(
    "ATV:RSV",
    "WT_ATV-DNP02",
    "days_01",
    "WT_ATV-4D9",
    "APP-SAA_ATV-DNP02",
    "APP-SAA_ATV-4D9"
  )
)

filtered_object$group <- factor(filtered_object$group,
  levels = c(
    "ATV:RSV",
    "WT_ATV-DNP02",
    "days_01",
    "WT_ATV-4D9",
    "APP-SAA_ATV-DNP02",
    "APP-SAA_ATV-4D9"
  )
)

filtered_object$group <- plyr::mapvalues(filtered_object$group,
  from = c(
    "ATV:RSV",
    "WT_ATV-DNP02",
    "days_01",
    "WT_ATV-4D9",
    "APP-SAA_ATV-DNP02",
    "APP-SAA_ATV-4D9"
  ),
  to = c(
    "Study1_WT-ATV-RSV",
    "Study2_WT-ATV-DNP02",
    "Study1_WT-ATV-4D9",
    "Study2_WT-ATV-4D9",
    "APP/SAA-ATV-DNP02",
    "APP/SAA-ATV-4D9"
  )
)

filtered_object <- ScaleData(filtered_object, features = score_genes)
filtered_object$mouse <- paste0(filtered_object$group, 
                                "_", 
                                filtered_object$sample)

Idents(filtered_object) <- "mouse"

sample_annotation <- filtered_object@meta.data %>%
  select(c(group, treatment, mouse)) %>%
  distinct(.)
sample_annotation$group <- factor(sample_annotation$group,
  levels = c(
    "Study1_WT-ATV-RSV",
    "Study2_WT-ATV-DNP02",
    "Study1_WT-ATV-4D9",
    "Study2_WT-ATV-4D9",
    "APP/SAA-ATV-DNP02",
    "APP/SAA-ATV-4D9"
  )
)
sample_annotation <- sample_annotation %>%
  group_by(group) %>%
  dplyr::arrange(.by_group = T) %>%
  as.data.frame()
rownames(sample_annotation) <- sample_annotation$mouse

sample_annotation_slim <- sample_annotation %>% dplyr::select(group)
rownames(sample_annotation_slim) <- sample_annotation$mouse
```

```{r, include=FALSE}
chen_averages <-
  AverageExpression(filtered_object,
                    features = rownames(chen_annotation),
                    group.by = "mouse")
topics_averages <-
  AverageExpression(filtered_object,
                    features = rownames(topics_annotation),
                    group.by = "mouse")
```

```{r, echo=FALSE, fig.width=6.5, fig.height=10.5}
pheatmap::pheatmap(
  mat = chen_averages$RNA[, rownames(sample_annotation_slim)],
  scale = "row",
  annotation_row = chen_annotation,
  annotation_col = data.frame(sample_annotation_slim),
  annotation_colors = chen_annotation_colors,
  cluster_cols = F,
  cluster_rows = F,
  show_rownames = T,
  gaps_col = c(3, 7, 10, 14, 18),
  gaps_row = c(15, 40, 49, 55),
  main = "Chen/Colonna Review Signature Genes",
  color = rev(colorRampPalette(RColorBrewer::brewer.pal(11, "RdBu"))(256))
)
```


```{r, echo=FALSE, fig.width=7.5, fig.height=10}
pheatmap::pheatmap(
  mat = topics_averages$RNA[, rownames(sample_annotation_slim)],
  scale = "row",
  annotation_row = topics_annotation,
  annotation_col = data.frame(sample_annotation_slim),
  annotation_colors = topics_annotation_colors,
  cluster_cols = F,
  cluster_rows = F,
  show_rownames = T,
  gaps_col = c(3, 7, 10, 14, 18),
  gaps_row = c(14, 29, 35, 42),
  main = "Microglia Map Topic Model Genes",
  color = rev(colorRampPalette(RColorBrewer::brewer.pal(11, "RdBu"))(256))
)
```

```{r, eval=FALSE}
microglia_Study2$mouse <-
  paste0(microglia_Study2$group, "_", microglia_Study2$sample)

counts <- microglia_Study2@assays$RNA@counts
meta <- transform(microglia_Study2@meta.data)

sce <-
  SingleCellExperiment::SingleCellExperiment(assays = list(counts = counts), 
                                             colData = meta)
```
